<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PrepZen - 在线练习</title>
    
    <!-- Favicon -->
    <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%234EFFFE'%3E%3Cpath d='M12 3L2 9l10 6 10-6L12 3Zm0 3.84L17.55 10 12 12.16 6.45 10 12 6.84Z'/%3E%3Cpath d='M5 14.5v-2h14v2h-14Z'/%3E%3Cpath d='M10 15v5h4v-5h-4Z'/%3E%3C/svg%3E" />

    <!-- 安全与版权元标签 -->
    <meta http-equiv="X-Frame-Options" content="DENY">
    <meta http-equiv="X-Content-Type-Options" content="nosniff">
    <meta name="referrer" content="strict-origin-when-cross-origin">
    <meta name="copyright" content="© 2025 PrepZen. All rights reserved.">
    <meta name="author" content="IhyaH">
    
    <!-- 依赖库 -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@iconify/iconify@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;500;700&display=swap" rel="stylesheet">
    
    <style>
        body {
            font-family: 'Noto Sans SC', sans-serif;
            background-color: #0f172a;
            color: #cbd5e1;
            -webkit-tap-highlight-color: transparent;
        }
        /* 交互动效 */
        .btn-hover { transition: all 0.3s ease; }
        .btn-hover:hover {
            transform: scale(1.05);
            box-shadow: 0 0 20px rgba(56, 189, 248, 0.4);
        }
        /* 粘性顶部栏 */
        .sticky-header {
            position: sticky;
            top: 0;
            z-index: 50;
            background-color: rgba(15, 23, 42, 0.85);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid #334155;
        }
        /* 卡片样式 */
        .card {
            background-color: #1e293b;
            border: 1px solid #334155;
        }
        /* 答题选项样式 */
        .option-label {
            position: relative; /* For icon positioning */
            transition: all 0.2s ease-in-out;
            border: 2px solid #334155;
            background-color: #1e293b;
        }
        .option-label:hover { border-color: #38bdf8; }
        .peer:checked + .option-label {
            border-color: #38bdf8;
            background-color: #334155;
        }
        .correct-answer {
            border-color: #22c55e !important;
            background-color: #16653433 !important;
            color: #dcfce7;
            box-shadow: 0 0 10px rgba(34, 197, 94, 0.5);
        }
        .wrong-answer {
            border-color: #ef4444 !important;
            background-color: #991b1b33 !important;
            color: #fee2e2;
            box-shadow: 0 0 10px rgba(239, 68, 68, 0.5);
        }
        .missed-answer {
            border-color: #f59e0b !important; /* New style for missed answers */
            background-color: #b4530933 !important;
            color: #fef3c7;
        }

        .feedback-icon {
            position: absolute;
            right: 1rem;
            top: 50%;
            transform: translateY(-50%);
            font-size: 1.5rem;
        }
        .feedback-icon.correct { color: #22c55e; }
        .feedback-icon.wrong { color: #ef4444; }
        .feedback-icon.missed { color: #f59e0b; } /* New icon color */
        
        @keyframes shake {
          10%, 90% { transform: translate3d(-1px, -50%, 0); }
          20%, 80% { transform: translate3d(2px, -50%, 0); }
          30%, 50%, 70% { transform: translate3d(-4px, -50%, 0); }
          40%, 60% { transform: translate3d(4px, -50%, 0); }
        }
        .shake-animation .feedback-icon.wrong { animation: shake 0.82s cubic-bezier(.36,.07,.19,.97) both; }

        /* 按钮激活状态 */
        .active-count-btn, .active-type-btn {
            background-color: #38bdf8 !important;
            color: #0f172a !important;
            font-weight: bold;
        }
        /* Iconify 加载动画 */
        .spin { animation: spin 1s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        /* 源代码保护 */
        * { -webkit-user-select: none; -moz-user-select: none; -ms-user-select: none; user-select: none; }
        button, input, textarea, select, a { pointer-events: auto; }
        ::selection { background: transparent; }
        ::-moz-selection { background: transparent; }
        img { pointer-events: none; }
    </style>
</head>
<body class="min-h-screen">
    <!-- Header -->
    <header class="sticky-header text-slate-200">
        <nav class="container mx-auto px-6 py-4 flex items-center justify-between">
            <div class="flex items-center space-x-3">
                <span class="iconify text-cyan-400 text-3xl" data-icon="streamline-pixel:school-science-graduation-cap"></span>
                <h1 class="text-2xl font-bold">PrepZen</h1>
            </div>
            <a href="index.html" class="font-medium hover:text-cyan-400 transition-colors inline-flex items-center">
                <span class="iconify mr-2" data-icon="mdi:home"></span>返回首页
            </a>
        </nav>
    </header>

    <main id="app" class="w-full max-w-4xl mx-auto p-4 sm:p-6">
        
        <!-- Start Screen -->
        <div id="start-screen" class="text-center card p-8 rounded-2xl shadow-lg">
            <h1 class="text-3xl md:text-4xl font-bold text-white mb-4">练习设置</h1>
            
            <div class="mb-8">
                <div id="current-bank-display" class="inline-flex items-center bg-slate-700 text-cyan-300 font-semibold py-3 px-6 rounded-full">
                    <span class="iconify mr-2" data-icon="mdi:calculator"></span>
                    <span id="bank-name">加载中...</span>
                </div>
            </div>

            <div id="password-section" class="mb-8 hidden">
                <div class="bg-slate-800 border border-yellow-500/50 rounded-lg p-6 max-w-md mx-auto">
                    <div class="text-center mb-4">
                        <span class="iconify text-yellow-400 text-3xl mb-2" data-icon="mdi:lock"></span>
                        <h3 class="text-lg font-semibold text-yellow-300">题库密码验证</h3>
                        <p id="password-hint" class="text-yellow-400 text-sm mt-1">请输入题库密码</p>
                    </div>
                    <div class="space-y-4">
                        <input type="password" id="bank-password" class="w-full px-4 py-3 bg-slate-900 border border-slate-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-yellow-500" placeholder="请输入密码">
                        <button id="verify-password-btn" class="w-full bg-yellow-600 text-white font-semibold py-3 px-4 rounded-lg hover:bg-yellow-700 transition-colors inline-flex items-center justify-center">
                            <span class="iconify mr-2" data-icon="mdi:key-variant"></span>验证密码
                        </button>
                    </div>
                    <div id="password-error" class="hidden mt-3 text-red-400 text-sm text-center">
                        <span class="iconify mr-1" data-icon="mdi:alert-triangle"></span>
                        <span id="password-error-text">密码错误，请重试</span>
                    </div>
                </div>
            </div>

            <!-- Settings Container (hidden until password is verified if needed) -->
            <div id="settings-container" class="hidden">
                <p class="text-slate-400 mb-8">请配置你的练习，然后开始挑战吧！</p>
                <div class="space-y-8 mb-10 text-center">
                    <!-- Question Type Selection -->
                    <div>
                        <h2 class="text-xl font-semibold text-white mb-4">题型选择</h2>
                        <div id="question-type-selector" class="flex flex-wrap justify-center gap-3"></div>
                    </div>
                    <!-- Question Count Selection -->
                    <div>
                        <h2 class="text-xl font-semibold text-white mb-4">数量选择</h2>
                        <div id="question-count-selector" class="flex flex-wrap justify-center gap-3"></div>
                    </div>
                </div>
                
                <div class="flex flex-col sm:flex-row justify-center gap-4">
                    <button id="start-btn" class="btn-hover bg-cyan-500 text-white font-bold py-3 px-8 rounded-full shadow-lg inline-flex items-center justify-center text-lg">
                        <span class="iconify mr-2" data-icon="mdi:play"></span>开始答题
                    </button>
                    <button id="browse-btn" class="btn-hover bg-slate-700/80 text-slate-100 font-bold py-3 px-8 rounded-full inline-flex items-center justify-center text-lg">
                        <span class="iconify mr-2" data-icon="mdi:book-open-variant"></span>浏览题目
                    </button>
                </div>
            </div>
        </div>

        <!-- Browse Mode -->
        <div id="browse-container" class="hidden">
            <div class="text-center mb-6">
                <h2 class="text-3xl font-bold text-white">题目浏览</h2>
                <p class="text-slate-400 mt-2">列表模式浏览所有题目</p>
            </div>
            <div id="browse-type-selector" class="flex justify-center flex-wrap gap-3 sm:gap-4 mb-6"></div>
            <div id="browse-questions-list" class="card p-6 rounded-2xl space-y-6"></div>
            <div class="text-center mt-8">
                <button id="back-to-start-btn" class="btn-hover bg-slate-700 text-white font-bold py-3 px-8 rounded-full inline-flex items-center justify-center">
                    <span class="iconify mr-2" data-icon="mdi:home"></span>返回设置
                </button>
            </div>
        </div>
        
        <!-- Quiz Mode -->
        <div id="quiz-container" class="hidden">
            <div class="sticky-header mb-6 p-4 rounded-b-xl -mx-4 -mt-4 sm:-mx-6 sm:-mt-6 sm:px-6">
                <div class="flex flex-wrap justify-between items-center text-center">
                    <div class="w-1/2 sm:w-1/4 p-2"><p class="text-sm text-slate-400">正确</p><p id="correct-count" class="text-2xl font-bold text-green-400">0</p></div>
                    <div class="w-1/2 sm:w-1/4 p-2"><p class="text-sm text-slate-400">错误</p><p id="wrong-count" class="text-2xl font-bold text-red-400">0</p></div>
                    <div class="w-1/2 sm:w-1/4 p-2"><p class="text-sm text-slate-400">正确率</p><p id="accuracy" class="text-2xl font-bold text-cyan-400">0%</p></div>
                    <div class="w-1/2 sm:w-1/4 p-2"><p class="text-sm text-slate-400">进度</p><p id="progress-text" class="text-2xl font-bold text-slate-200">0/0</p></div>
                </div>
                <div class="w-full bg-slate-700 rounded-full h-2.5 mt-3"><div id="progress-bar" class="bg-cyan-500 h-2.5 rounded-full transition-all duration-300"></div></div>
            </div>

            <div id="question-card" class="card p-6 sm:p-8 rounded-2xl shadow-lg">
                <div class="flex justify-between items-start mb-4">
                    <span id="question-type" class="bg-slate-700 text-cyan-300 text-sm font-semibold mr-3 px-3 py-1 rounded-full"></span>
                    <span id="question-counter" class="text-slate-400 font-medium"></span>
                </div>
                <h2 id="question-text" class="text-xl md:text-2xl font-bold text-white mb-6 min-h-[6rem]"></h2>
                <div id="options-container" class="space-y-4"></div>
                <div class="mt-8">
                    <button id="confirm-btn" class="w-full bg-cyan-600 text-white font-bold py-4 px-6 rounded-lg hover:bg-cyan-500 transition-colors disabled:bg-slate-600 disabled:cursor-not-allowed text-lg inline-flex items-center justify-center">
                        确认答案 <span class="iconify ml-2" data-icon="mdi:check"></span>
                    </button>
                </div>
            </div>
            
            <div id="result-screen" class="hidden text-center card p-8 rounded-2xl shadow-lg">
                 <h2 class="text-3xl font-bold text-white mb-4">答题完成！</h2>
                <div class="flex justify-around my-8">
                    <div><p class="text-lg text-slate-300">最终得分</p><p id="final-score" class="text-5xl font-bold text-cyan-400">0%</p></div>
                    <div><p class="text-lg text-slate-300">答错题目</p><p id="wrong-total" class="text-5xl font-bold text-red-400">0</p></div>
                </div>
                <div class="mt-8 w-full max-w-sm mx-auto flex flex-col sm:flex-row sm:space-x-4 space-y-4 sm:space-y-0">
                    <button id="review-wrong-btn" class="btn-hover w-full bg-red-600 text-white font-bold py-3 px-6 rounded-full disabled:bg-red-800 disabled:opacity-50 disabled:cursor-not-allowed inline-flex items-center justify-center">
                        <span class="iconify mr-2" data-icon="mdi:book-open-variant"></span>重练错题
                    </button>
                    <button id="restart-btn" class="btn-hover w-full bg-slate-700 text-white font-bold py-3 px-6 rounded-full inline-flex items-center justify-center">
                        <span class="iconify mr-2" data-icon="mdi:home"></span>返回设置
                    </button>
                </div>
                 <div id="wrong-questions-list" class="mt-8 text-left hidden"></div>
            </div>
        </div>
        
        <!-- Footer -->
        <footer class="bg-transparent text-slate-400 py-12">
            <div class="container mx-auto px-6 text-center">
                <p>&copy; <span id="current-year"></span> PrepZen. All Rights Reserved.</p>
                <a href="https://github.com/IhyaH" target="_blank" class="hover:text-cyan-400 transition-colors inline-flex items-center mt-2">
                    <span class="iconify mr-1" data-icon="mdi:github"></span> GitHub
                </a>
            </div>
        </footer>
    </main>

    <script src="./data/question-loader.js"></script>
    
    <script>
        // --- DATA ---
        let questionsData = [];
        let browseQuestions = [];

        // --- DOM ELEMENTS ---
        const startScreen = document.getElementById('start-screen');
        const quizContainer = document.getElementById('quiz-container');
        const browseContainer = document.getElementById('browse-container');
        const settingsContainer = document.getElementById('settings-container');
        const startBtn = document.getElementById('start-btn');
        const browseBtn = document.getElementById('browse-btn');
        const confirmBtn = document.getElementById('confirm-btn');
        const restartBtn = document.getElementById('restart-btn');
        const reviewWrongBtn = document.getElementById('review-wrong-btn');
        const questionCard = document.getElementById('question-card');
        const resultScreen = document.getElementById('result-screen');
        const questionCountSelector = document.getElementById('question-count-selector');
        const correctCountEl = document.getElementById('correct-count');
        const wrongCountEl = document.getElementById('wrong-count');
        const accuracyEl = document.getElementById('accuracy');
        const progressTextEl = document.getElementById('progress-text');
        const progressBarEl = document.getElementById('progress-bar');
        const questionTypeEl = document.getElementById('question-type');
        const questionTextEl = document.getElementById('question-text');
        const optionsContainerEl = document.getElementById('options-container');
        const finalScoreEl = document.getElementById('final-score');
        const wrongTotalEl = document.getElementById('wrong-total');
        const wrongQuestionsListEl = document.getElementById('wrong-questions-list');
        const backToStartBtn = document.getElementById('back-to-start-btn');

        // --- State ---
        let questions = [];
        let currentQuestionIndex = 0;
        let correctCount = 0;
        let wrongCount = 0;
        let wrongAnswers = [];
        let selectedAnswers = [];
        let isAnswered = false;
        let selectedQuestionCount = 'all';
        let selectedQuestionType = 'all';
        let currentBrowseQuestions = [];
        
        // --- Functions ---
        function shuffleArray(array) {
            let newArr = [...array];
            for (let i = newArr.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [newArr[i], newArr[j]] = [newArr[j], newArr[i]];
            }
            return newArr;
        }
        
        function getTypeConfig(type) {
            const typeConfig = {
                "单选题": { icon: "mdi:record-circle-outline" },
                "多选题": { icon: "mdi:check-box-multiple-outline" },
                "判断题": { icon: "mdi:help-circle-outline" },
                "填空题": { icon: "mdi:pencil-outline" },
                "简答题": { icon: "mdi:format-align-left" }
            };
            return typeConfig[type] || { icon: "mdi:help-circle" };
        }

        function initBrowseMode(questionSet) {
            startScreen.classList.add('hidden');
            quizContainer.classList.add('hidden');
            browseContainer.classList.remove('hidden');
            browseQuestions = questionSet;
            currentBrowseQuestions = [...browseQuestions];
            generateBrowseTypeButtons();
            renderBrowseQuestionsList(currentBrowseQuestions);
        }

        function generateBrowseTypeButtons() {
            const container = document.getElementById('browse-type-selector');
            container.innerHTML = '';
            const typeCounts = browseQuestions.reduce((acc, q) => {
                acc[q.type] = (acc[q.type] || 0) + 1;
                return acc;
            }, {});
            
            const createBtn = (type, count, icon) => `<button data-type="${type}" class="type-btn ${type === 'all' ? 'active-type-btn' : 'bg-slate-800'} text-slate-300 font-semibold py-2 px-4 rounded-full inline-flex items-center"><span class="iconify mr-2" data-icon="${icon}"></span>${type === 'all' ? '全部' : type} (${count})</button>`;
            
            container.innerHTML += createBtn('all', browseQuestions.length, 'mdi:format-list-bulleted');
            
            Object.entries(typeCounts).forEach(([type, count]) => {
                const config = getTypeConfig(type);
                container.innerHTML += createBtn(type, count, config.icon);
            });
            
            container.querySelectorAll('.type-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    container.querySelectorAll('.type-btn').forEach(b => b.classList.remove('active-type-btn'));
                    this.classList.add('active-type-btn');
                    currentBrowseQuestions = this.dataset.type === 'all' ? [...browseQuestions] : browseQuestions.filter(q => q.type === this.dataset.type);
                    renderBrowseQuestionsList(currentBrowseQuestions);
                });
            });
        }

        function renderBrowseQuestionsList(questions) {
            const container = document.getElementById('browse-questions-list');
            container.innerHTML = questions.length === 0 ? '<p class="text-center text-slate-400 py-4">该类型下没有题目</p>' : '';
            questions.forEach((q, index) => {
                const item = document.createElement('div');
                item.className = 'browse-question-item border-b border-slate-700 pb-6 last:border-0 last:pb-0';
                const optionsHtml = q.options ? q.options.map((opt, i) => `<div class="option-btn block w-full text-left p-3 border border-slate-600 rounded-lg bg-slate-800"><span class="font-bold mr-3">${q.type === '判断题' ? '' : ['A', 'B', 'C', 'D', 'E', 'F'][i] + '.'}</span>${(q.type !== '判断题' && opt.includes('、')) ? opt.substring(opt.indexOf('、') + 1) : opt}</div>`).join('') : '';
                item.innerHTML = `
                    <div class="flex justify-between items-start mb-2"><span class="bg-slate-700 text-cyan-300 text-sm font-semibold mr-3 px-3 py-1 rounded-full">【${q.type}】</span><span class="text-slate-400 font-medium">#${index + 1}</span></div>
                    <div class="text-lg font-medium text-white mb-4">${q.question.replace(/\uff08\s*\uff09/g, '(____)')}</div>
                    ${q.options ? `<div class="options-container space-y-2 mb-4">${optionsHtml}</div>` : ''}
                    <div class="answer-explanation mt-4 p-4 bg-green-900/30 border border-green-500/30 rounded-lg">
                        <p class="text-green-300 font-semibold">正确答案：<span class="correct-answer-text">${Array.isArray(q.answer) ? q.answer.join(', ') : q.answer}</span></p>
                        ${q.explanation ? `<p class="text-slate-300 mt-2"><strong>解析:</strong> <span class="explanation-text">${q.explanation.replace(/\n/g, '<br>')}</span></p>` : ''}
                    </div>`;
                container.appendChild(item);
            });
        }

        async function initQuiz(questionSet, isReviewMode = false) {
            currentQuestionIndex = 0;
            correctCount = 0;
            wrongCount = 0;
            if (!isReviewMode) wrongAnswers = [];
            questions = questionSet;
            startScreen.classList.add('hidden');
            browseContainer.classList.add('hidden');
            resultScreen.classList.add('hidden');
            quizContainer.classList.remove('hidden');
            questionCard.classList.remove('hidden');
            updateStats();
            displayQuestion();
        }

        function displayQuestion() {
            if (currentQuestionIndex >= questions.length) {
                showResults();
                return;
            }
            isAnswered = false;
            selectedAnswers = [];
            confirmBtn.disabled = true;
            confirmBtn.innerHTML = '确认答案 <span class="iconify ml-2" data-icon="mdi:check"></span>';
            const q = questions[currentQuestionIndex];
            questionTypeEl.textContent = `【${q.type}】`;
            questionTextEl.innerHTML = q.question.replace(/\uff08\s*\uff09/g, '<span class="text-slate-400">(____)</span>');
            optionsContainerEl.innerHTML = '';
            
            if (q.type === '填空题' || q.type === '简答题') {
                const isShortAnswer = q.type === '简答题';
                if (isShortAnswer) {
                    optionsContainerEl.innerHTML = `<textarea id="short-answer-input" class="w-full p-4 bg-slate-900 border-2 border-slate-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-cyan-500 min-h-[120px]" placeholder="请输入您的答案"></textarea>`;
                    document.getElementById('short-answer-input').addEventListener('input', e => {
                        selectedAnswers = [e.target.value];
                        confirmBtn.disabled = selectedAnswers[0].trim() === '';
                    });
                } else {
                    selectedAnswers = new Array((q.question.match(/____/g) || []).length).fill('');
                    questionTextEl.innerHTML = q.question.replace(/____/g, (_, offset) => `<input type="text" class="fill-blank-input inline-block w-32 px-2 py-1 bg-slate-900 border border-slate-600 rounded-md focus:outline-none focus:ring-2 focus:ring-cyan-500" data-fill-blank-index="${(q.question.substring(0, offset).match(/____/g) || []).length}">`);
                    questionTextEl.querySelectorAll('.fill-blank-input').forEach(input => {
                        input.addEventListener('input', () => {
                            selectedAnswers = Array.from(questionTextEl.querySelectorAll('.fill-blank-input')).map(i => i.value.trim());
                            confirmBtn.disabled = selectedAnswers.some(ans => ans === '');
                        });
                    });
                }
            } else if (q.options) {
                q.options.forEach((opt, index) => {
                    const isMulti = q.type === '多选题';
                    const letters = ['A', 'B', 'C', 'D', 'E', 'F'];
                    const val = q.type === '判断题' ? opt : letters[index];
                    const optText = (q.type !== '判断题' && opt.includes('、')) ? opt.substring(opt.indexOf('、') + 1) : opt;
                    optionsContainerEl.innerHTML += `
                        <div>
                            <input type="${isMulti ? 'checkbox' : 'radio'}" id="opt-${index}" name="option" value="${val}" class="hidden peer">
                            <label for="opt-${index}" class="option-label block w-full text-left p-4 rounded-lg cursor-pointer">
                                <span class="font-bold mr-3">${q.type === '判断题' ? '' : letters[index] + '.'}</span>${optText}
                            </label>
                        </div>`;
                });
                optionsContainerEl.querySelectorAll('input').forEach(el => el.addEventListener('change', handleOptionSelect));
            }
            updateStats();
        }

        function handleOptionSelect() {
            const q = questions[currentQuestionIndex];
            selectedAnswers = Array.from(optionsContainerEl.querySelectorAll(q.type === '多选题' ? 'input[type="checkbox"]:checked' : 'input[type="radio"]:checked')).map(el => el.value);
            confirmBtn.disabled = selectedAnswers.length === 0;
        }

        function checkAnswer() {
            const q = questions[currentQuestionIndex];
            const correct = Array.isArray(q.answer) ? q.answer : [q.answer];
            let isCorrect = selectedAnswers.sort().join(',') === correct.sort().join(',');

            if (q.options) {
                // Logic for Multiple Choice questions when the answer is not entirely correct
                if (q.type === '多选题' && !isCorrect) {
                     optionsContainerEl.querySelectorAll('input').forEach(input => {
                        const label = input.nextElementSibling;
                        input.disabled = true;
                        const isUserChoice = input.checked;
                        const isCorrectAnswer = correct.includes(input.value);

                        const iconSpan = document.createElement('span');
                        iconSpan.className = 'feedback-icon';

                        if (isCorrectAnswer) {
                            if (isUserChoice) {
                                label.classList.add('correct-answer');
                                iconSpan.classList.add('correct');
                                iconSpan.innerHTML = '<span class="iconify" data-icon="mdi:check-circle-outline"></span>';
                                label.appendChild(iconSpan);
                            } else {
                                // This is a missed correct answer
                                label.classList.add('missed-answer');
                                iconSpan.classList.add('missed');
                                iconSpan.innerHTML = '<span class="iconify" data-icon="mdi:alert-circle-outline"></span>';
                                label.appendChild(iconSpan);
                            }
                        } else if (isUserChoice) {
                            // This is an incorrect answer that the user picked
                            label.classList.add('wrong-answer', 'shake-animation');
                            iconSpan.classList.add('wrong');
                            iconSpan.innerHTML = '<span class="iconify" data-icon="mdi:close-circle-outline"></span>';
                            label.appendChild(iconSpan);
                        }
                    });
                } else { // Logic for Single Choice, True/False, or perfectly correct Multiple Choice
                    optionsContainerEl.querySelectorAll('input').forEach(input => {
                        const label = input.nextElementSibling;
                        input.disabled = true;
                        const isUserChoice = input.checked;
                        const isCorrectAnswer = correct.includes(input.value);

                        if (isCorrectAnswer) {
                            label.classList.add('correct-answer');
                            const iconSpan = document.createElement('span');
                            iconSpan.className = 'feedback-icon correct';
                            iconSpan.innerHTML = '<span class="iconify" data-icon="mdi:check-circle-outline"></span>';
                            label.appendChild(iconSpan);
                        }
                        if (isUserChoice && !isCorrectAnswer) {
                            label.classList.add('wrong-answer', 'shake-animation');
                            const iconSpan = document.createElement('span');
                            iconSpan.className = 'feedback-icon wrong';
                            iconSpan.innerHTML = '<span class="iconify" data-icon="mdi:close-circle-outline"></span>';
                            label.appendChild(iconSpan);
                        }
                    });
                }
            } else { // Handle text inputs
                const inputs = document.querySelectorAll('.fill-blank-input, #short-answer-input');
                inputs.forEach((input, index) => {
                    input.disabled = true;
                    const isBlankCorrect = (input.value.trim().toLowerCase() === (correct[index] || '').trim().toLowerCase());
                    input.classList.add(isBlankCorrect ? 'correct-answer' : 'wrong-answer');
                });
            }
            
            if (isCorrect) correctCount++;
            else { wrongCount++; if (!wrongAnswers.includes(q)) wrongAnswers.push(q); }
            
            const explanationHtml = `<div class="mt-4 p-4 bg-slate-800 border border-slate-700 rounded-lg"><p class="text-green-300 font-semibold">正确答案：${correct.join(', ')}</p>${q.explanation ? `<p class="text-slate-300 mt-2"><strong>解析:</strong> ${q.explanation.replace(/\n/g, '<br>')}</p>` : ''}</div>`;
            optionsContainerEl.insertAdjacentHTML('beforeend', explanationHtml);
            
            updateStats();
            isAnswered = true;
            confirmBtn.innerHTML = '下一题 <span class="iconify ml-2" data-icon="mdi:arrow-right"></span>';
            confirmBtn.disabled = false;
        }

        function updateStats() {
            correctCountEl.textContent = correctCount;
            wrongCountEl.textContent = wrongCount;
            const total = correctCount + wrongCount;
            accuracyEl.textContent = `${total > 0 ? Math.round((correctCount / total) * 100) : 0}%`;
            progressTextEl.textContent = `${Math.min(currentQuestionIndex + 1, questions.length)}/${questions.length}`;
            progressBarEl.style.width = `${total > 0 ? ((correctCount + wrongCount) / questions.length) * 100 : 0}%`;
        }
        
        function showResults() {
            questionCard.classList.add('hidden');
            resultScreen.classList.remove('hidden');
            const score = questions.length > 0 ? Math.round((correctCount / questions.length) * 100) : 0;
            finalScoreEl.textContent = `${score}%`;
            wrongTotalEl.textContent = wrongAnswers.length;
            reviewWrongBtn.disabled = wrongAnswers.length === 0;
            wrongQuestionsListEl.innerHTML = wrongAnswers.length > 0 ? '<h3 class="text-xl font-bold mb-4 text-center text-white">错题回顾</h3>' : '';
            wrongAnswers.forEach((q, index) => {
                wrongQuestionsListEl.innerHTML += `<div class="card p-4 mb-4"><p class="font-semibold text-white">${index + 1}. ${q.question}</p><p class="text-green-300 mt-2">答案: ${Array.isArray(q.answer) ? q.answer.join(', ') : q.answer}</p>${q.explanation ? `<p class="text-slate-300 mt-2">解析: ${q.explanation}</p>` : ''}</div>`;
            });
            wrongQuestionsListEl.classList.toggle('hidden', wrongAnswers.length === 0);
        }
        
        // --- Event Listeners and Initialization ---
        const urlParams = new URLSearchParams(window.location.search);
        let selectedQuestionBank = urlParams.get('bank') || 'engineering-budget';
        let currentBankPassword = null;
        let bankInfo = null;
        
        async function initializeBankInfo() {
            try {
                bankInfo = await questionLoader.getQuestionBankInfo(selectedQuestionBank);
                document.title = `${bankInfo.subject} - PrepZen 练习`;
                document.getElementById('bank-name').textContent = bankInfo.subject;
                
                if (bankInfo.hasPassword) {
                    document.getElementById('password-section').classList.remove('hidden');
                    // 设置密码提示
                    const passwordHintElement = document.getElementById('password-hint');
                    if (bankInfo.passwordHint) {
                        passwordHintElement.textContent = bankInfo.passwordHint;
                    }
                } else {
                    settingsContainer.classList.remove('hidden');
                }
                                
                updateQuestionTypeSelector(bankInfo);
                generateQuestionCountButtons(bankInfo.questionStats.totalQuestions);
            } catch (error) { console.error('Failed to initialize bank info:', error); alert('加载题库信息失败'); }
        }
        
        function updateQuestionTypeSelector(bankInfo) {
            const container = document.getElementById('question-type-selector');
            container.innerHTML = '';
            const stats = bankInfo.questionStats || { totalQuestions: 0, questionTypesCount: {} };
            const addButton = (type, count, icon, color) => {
                const isActive = type === 'all';
                container.innerHTML += `<button data-type="${type}" class="type-btn ${isActive ? 'active-type-btn' : 'bg-slate-700'} text-slate-200 font-semibold py-2 px-4 rounded-full inline-flex items-center"><span class="iconify mr-2" data-icon="${icon}"></span>${type === 'all' ? '全部题型' : type} <span class="bg-slate-800/50 text-xs px-1.5 py-0.5 rounded-full ml-1">${count}</span></button>`;
            };
            addButton('all', stats.totalQuestions, 'mdi:format-list-bulleted');
            Object.entries(stats.questionTypesCount).forEach(([type, count]) => {
                if (count > 0) {
                    const config = getTypeConfig(type);
                    addButton(type, count, config.icon, config.color);
                }
            });
            container.querySelectorAll('.type-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    container.querySelectorAll('.type-btn').forEach(b => b.classList.remove('active-type-btn', 'bg-cyan-500'));
                    this.classList.add('active-type-btn');
                    selectedQuestionType = this.dataset.type;
                    const countForType = selectedQuestionType === 'all' ? stats.totalQuestions : (stats.questionTypesCount[selectedQuestionType] || 0);
                    generateQuestionCountButtons(countForType);
                });
            });
        }
        
        function generateQuestionCountButtons(total) {
            const container = document.getElementById('question-count-selector');
            container.innerHTML = '';
            const options = [10, 20, 50, 100];
            options.forEach(count => {
                if (count < total) container.innerHTML += `<button data-count="${count}" class="count-btn bg-slate-700 text-slate-200 font-semibold py-2 px-4 rounded-full">${count} 题</button>`;
            });
            container.innerHTML += `<button data-count="all" class="count-btn active-count-btn bg-slate-700 text-slate-200 font-semibold py-2 px-4 rounded-full">全部</button>`;
            selectedQuestionCount = 'all';
            container.querySelectorAll('.count-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    container.querySelectorAll('.count-btn').forEach(b => b.classList.remove('active-count-btn'));
                    this.classList.add('active-count-btn');
                    selectedQuestionCount = this.dataset.count;
                });
            });
        }
        
        async function verifyPassword() {
            const password = document.getElementById('bank-password').value.trim();
            if (!password) return;
            const btn = document.getElementById('verify-password-btn');
            btn.disabled = true; btn.innerHTML = '<span class="iconify spin mr-2" data-icon="mdi:loading"></span>';
            try {
                await questionLoader.loadQuestions(selectedQuestionBank, password);
                currentBankPassword = password;
                document.getElementById('password-section').classList.add('hidden');
                settingsContainer.classList.remove('hidden');
            } catch (error) { 
                document.getElementById('password-error').classList.remove('hidden'); 
            } finally { 
                btn.disabled = false; 
                btn.innerHTML = '<span class="iconify mr-2" data-icon="mdi:key-variant"></span>验证密码'; 
            }
        }
        
        async function loadAndStart(mode) {
            if (bankInfo && bankInfo.hasPassword && !currentBankPassword) {
                document.getElementById('password-section').classList.remove('hidden'); return;
            }
            const btn = mode === 'quiz' ? startBtn : browseBtn;
            const originalHtml = btn.innerHTML;
            btn.disabled = true; btn.innerHTML = '<span class="iconify spin mr-2" data-icon="mdi:loading"></span>';
            try {
                const data = await questionLoader.loadQuestions(selectedQuestionBank, currentBankPassword);
                questionsData = data.questions;
                if (mode === 'quiz') {
                    let filtered = selectedQuestionType === 'all' ? questionsData : questionsData.filter(q => q.type === selectedQuestionType);
                    let shuffled = shuffleArray(filtered);
                    let set = selectedQuestionCount === 'all' ? shuffled : shuffled.slice(0, parseInt(selectedQuestionCount));
                    if (set.length === 0) alert('没有找到符合条件的题目！'); else initQuiz(set);
                } else { initBrowseMode(questionsData); }
            } catch (error) { alert('加载题目失败！'); }
            finally { btn.disabled = false; btn.innerHTML = originalHtml; }
        }
        
        document.addEventListener('DOMContentLoaded', () => {
            // Add DevTools and context menu protection
            (function() {
                'use strict';
                document.addEventListener('contextmenu', e => e.preventDefault());
                document.addEventListener('keydown', e => {
                    if (e.key === 'F12' || (e.ctrlKey && e.shiftKey && ['I', 'J', 'C'].includes(e.key.toUpperCase())) || (e.ctrlKey && e.key === 'u')) {
                        e.preventDefault();
                    }
                });
                if (window.console) {
                    console.log('%c PrepZen %c 学习使我快乐 ', 'background:#0e7490;color:#fff;padding:5px 10px;border-radius:3px 0 0 3px;', 'background:#0f172a;color:#fff;padding:5px 10px;border-radius:0 3px 3px 0;');
                }
            })();

            initializeBankInfo();
            document.getElementById('current-year').textContent = new Date().getFullYear();
            document.getElementById('verify-password-btn').addEventListener('click', verifyPassword);
            document.getElementById('bank-password').addEventListener('keypress', (e) => e.key === 'Enter' && verifyPassword());
            startBtn.addEventListener('click', () => loadAndStart('quiz'));
            browseBtn.addEventListener('click', () => loadAndStart('browse'));
            confirmBtn.addEventListener('click', () => isAnswered ? (currentQuestionIndex++, displayQuestion()) : checkAnswer());
            restartBtn.addEventListener('click', () => { quizContainer.classList.add('hidden'); startScreen.classList.remove('hidden'); });
            reviewWrongBtn.addEventListener('click', () => initQuiz(shuffleArray(wrongAnswers), true));
            backToStartBtn.addEventListener('click', () => { browseContainer.classList.add('hidden'); startScreen.classList.remove('hidden'); });
        });
    </script>
</body>
</html>